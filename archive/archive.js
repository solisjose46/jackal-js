var bounds = [
    {
        x: 65,
        y: 2872
    
    },
    {
        x: 65,
        y: 2142
    
    },
    {
        x: 320,
        y: 2142
    
    },
    {
        x: 320,
        y: 2112
    
    },
    {
        x: 180,
        y: 2112
    
    },
    {
        x: 180,
        y: 1947
    
    },
    {
        x: 223,
        y: 1947
    
    },
    {
        x: 223,
        y: 1919
    
    },
    {
        x: 160,
        y: 1919
    
    },
    {
        x: 286,
        y: 1772
    
    },
    {
        x: 270,
        y: 1726
    
    },
    {
        x: 130,
        y: 1726
    
    },
    {
        x: 130,
        y: 1762
    
    },
    {
        x: 70,
        y: 2081
    
    },
    {
        x: 25,
        y: 1765
    
    },
    {
        x: 25,
        y: 1362
    
    },
    {
        x: 58,
        y: 1322
    
    },
    {
        x: 58,
        y: 1269
    
    },
    {
        x: 25,
        y: 1263
    
    },
    {
        x: 25,
        y: 1186
    
    },
    {
        x: 60,
        y: 1151
    
    },
    {
        x: 60,
        y: 1120
    
    },
    {
        x: 90,
        y: 1091
    
    },
    {
        x: 90,
        y: 1040
    
    },
    {
        x: 25,
        y: 990
    
    },
    {
        x: 25,
        y: 945
    
    },
    {
        x: 60,
        y: 911
    
    },
    {
        x: 66,
        y: 750
    
    },
    {
        x: 25,
        y: 750
    
    },
    {
        x: 25,
        y: 590
    
    },
    {
        x: 98,
        y: 590
    
    },
    {
        x: 98,
        y: 510
    
    },
    {
        x: 50,
        y: 510
    
    },
    {
        x: 60,
        y: 466
    
    },
    {
        x: 128,
        y: 466
    
    },
    {
        x: 187,
        y: 462
    
    },
    {
        x: 187,
        y: 290
    
    },
    {
        x: 137,
        y: 290
    
    },
    {
        x: 90,
        y: 240
    
    },
    {
        x: 90,
        y: 97
    
    },
    {
        x: 123,
        y: 64
    
    },
    {
        x: 388,
        y: 64
    
    },
    {
        x: 422,
        y: 98
    
    },
    {
        x: 422,
        y: 239
    
    },
    {
        x: 367,
        y: 250
    
    },
    {
        x: 327,
        y: 291
    
    },
    {
        x: 327,
        y: 400
    
    },
    {
        x: 389,
        y: 462
    
    },
    {
        x: 455,
        y: 462
    
    },
    {
        x: 455,
        y: 516
    
    },
    {
        x: 487,
        y: 546
    
    },
    {
        x: 487,
        y: 607
    
    },
    {
        x: 445,
        y: 607
    
    },
    {
        x: 445,
        y: 642
    
    },
    {
        x: 487,
        y: 645
    
    },
    {
        x: 487,
        y: 753
    
    },
    {
        x: 430,
        y: 803
    
    },
    {
        x: 370,
        y: 760
    
    },
    {
        x: 238,
        y: 760
    
    },
    {
        x: 221,
        y: 793
    
    },
    {
        x: 142,
        y: 793
    
    },
    {
        x: 142,
        y: 847
    
    },
    {
        x: 256,
        y: 847
    
    },
    {
        x: 288,
        y: 814
    
    },
    {
        x: 309,
        y: 847
    
    },
    {
        x: 422,
        y: 847
    
    },
    {
        x: 486,
        y: 913
    
    },
    {
        x: 486,
        y: 966
    
    },
    {
        x: 447,
        y: 966
    
    },
    {
        x: 447,
        y: 1215
    
    },
    {
        x: 290,
        y: 1374
    
    },
    {
        x: 290,
        y: 1454
    
    },
    {
        x: 130,
        y: 1614
    
    },
    {
        x: 130,
        y: 1661
    
    },
    {
        x: 272,
        y: 1661
    
    },
    {
        x: 352,
        y: 1571
    
    },
    {
        x: 352,
        y: 1670
    
    },
    {
        x: 457,
        y: 1670
    
    },
    {
        x: 457,
        y: 1806
    
    },
    {
        x: 357,
        y: 1775
    
    },
    {
        x: 357,
        y: 1810
    
    },
    {
        x: 386,
        y: 1841
    
    },
    {
        x: 457,
        y: 1841
    
    },
    {
        x: 487,
        y: 1871
    
    },
    {
        x: 487,
        y: 1929
    
    },
    {
        x: 257,
        y: 1920
    
    },
    {
        x: 277,
        y: 1951
    
    },
    {
        x: 496,
        y: 1951
    
    },
    {
        x: 496,
        y: 2112
    
    },
    {
        x: 385,
        y: 2112
    
    },
    {
        x: 385,
        y: 2144
    
    },
    {
        x: 490,
        y: 2144
    
    },
    {
        x: 490,
        y: 2254
    
    },
    {
        x: 420,
        y: 2316
    
    },
    {
        x: 488,
        y: 2387
    
    },
    {
        x: 488,
        y: 2432
    
    },
    {
        x: 455,
        y: 2452
    
    },
    {
        x: 455,
        y: 2560
    
    },
    {
        x: 489,
        y: 2594
    
    },
    {
        x: 489,
        y: 2872
    }    
];
var nonRemovables = [
    {
        height: '30px',
        width: '40px',
        left: '160px',
        top: '95px'
    },
    {
        height: '30px',
        width: '40px',
        left: '222px',
        top: '126px'
    },
    {
        height: '30px',
        width: '40px',
        left: '350px',
        top: '126px'
    },
    {
        height: '30px',
        width: '40px',
        left: '320px',
        top: '157px'
    },
    {
        height: '67px',
        width: '67px',
        left: '384px',
        top: '510px'
    },
    {
        height: '30px',
        width: '40px',
        left: '166px',
        top: '965px'
    },
    {
        height: '30px',
        width: '40px',
        left: '132px',
        top: '1029px'
    },
    {
        height: '30px',
        width: '40px',
        left: '319px',
        top: '1020px'
    },
    {
        height: '25px',
        width: '161px',
        left: '190px',
        top: '1160px'
    },
    {
        height: '30px',
        width: '40px',
        left: '125px',
        top: '1160px'
    },
    {
        height: '30px',
        width: '40px',
        left: '310px',
        top: '1160px'
    },
    {
        height: '30px',
        width: '40px',
        left: '287px',
        top: '1230px'
    },
    {
        height: '30px',
        width: '40px',
        left: '255px',
        top: '1263px'
    },
    {
        height: '30px',
        width: '40px',
        left: '157px',
        top: '1263px'
    },
    {
        height: '30px',
        width: '40px',
        left: '128px',
        top: '1302px'
    },
    {
        height: '30px',
        width: '40px',
        left: '192px',
        top: '1359px'
    },
    {
        height: '72px',
        width: '73px',
        left: '65px',
        top: '1328px'
    },
    {
        height: '30px',
        width: '40px',
        left: '37px',
        top: '1476px'
    },
    {
        height: '37px',
        width: '70px',
        left: '65px',
        top: '1533px'
    },
    {
        height: '37px',
        width: '70px',
        left: '65px',
        top: '2287px'
    },
    {
        height: '30px',
        width: '40px',
        left: '129px',
        top: '2320px'
    },
    {
        height: '30px',
        width: '40px',
        left: '357px',
        top: '2261px'
    },
    {
        height: '30px',
        width: '40px',
        left: '294px',
        top: '2293px'
    },
    {
        height: '30px',
        width: '40px',
        left: '161px',
        top: '2432px'
    },
    {
        height: '30px',
        width: '40px',
        left: '193px',
        top: '2465px'
    },
    {
        height: '74px',
        width: '74px',
        left: '319px',
        top: '2431px'
    },
    {
        height: '30px',
        width: '40px',
        left: '164px',
        top: '2566px'
    },
    {
        height: '30px',
        width: '40px',
        left: '288px',
        top: '2596px'
    },
    {
        height: '30px',
        width: '40px',
        left: '255px',
        top: '2671px'
    },
    {
        height: '40px',
        width: '65px',
        left: '289px',
        top: '2704px'
    },
    {
        height: '30px',
        width: '40px',
        left: '293px',
        top: '2804px'
    }    
];
var tankLibrary = [
    {
        direction: 'south-west',
        img: 'tanks/blue-sw.png'
    },
    {
        direction: 'west',
        img: 'tanks/blue-w.png'
    },
    {
        direction: 'north-west',
        img: 'tanks/blue-nw.png'
    },
    {
        direction: 'north',
        img: 'tanks/blue-n.png'
    },
    {
        direction: 'north-east',
        img: 'tanks/blue-ne.png'
    },
    {
        direction: 'east',
        img: 'tanks/blue-e.png'
    },
    {
        direction: 'south-east',
        img: 'tanks/blue-se.png'
    },
    {
        direction: 'south',
        img: 'tanks/blue-s.png'
    }
];

var rocketLibrary = [
    {
        direction: 'south-west',
        img: 'assets/weapons/rocket-sw.png'
    },
    {
        direction: 'west',
        img: 'assets/weapons/rocket-w.png'
    },
    {
        direction: 'north-west',
        img: 'assets/weapons/rocket-nw.png'
    },
    {
        direction: 'north',
        img: 'assets/weapons/rocket-n.png'
    },
    {
        direction: 'north-east',
        img: 'assets/weapons/rocket-ne.png'
    },
    {
        direction: 'east',
        img: 'assets/weapons/rocket-e.png'
    },
    {
        direction: 'south-east',
        img: 'assets/weapons/rocket-se.png'
    },
    {
        direction: 'south',
        img: 'assets/weapons/rocket-s.png'
    }
];

var turretLibrary = [
    {
        direction: 'south-west',
        img: 'enemies/turret-sw.png'
    },
    {
        direction: 'west',
        img: 'enemies/turret-w.png'
    },
    {
        direction: 'north-west',
        img: 'enemies/turret-nw.png'
    },
    {
        direction: 'north',
        img: 'enemies/turret-n.png'
    },
    {
        direction: 'north-east',
        img: 'enemies/turret-ne.png'
    },
    {
        direction: 'east',
        img: 'enemies/turret-e.png'
    },
    {
        direction: 'south-east',
        img: 'enemies/turret-se.png'
    },
    {
        direction: 'south',
        img: 'enemies/turret-s.png'
    }
];

var turretLocations = [
    {
        left: '97px',
        top: '2495px'
    },
    {
        left: '191px',
        top: '2351px'
    },
    {
        left: '95px',
        top: '2191px'
    },
    {
        left: '255px',
        top: '2191px'
    },
    {
        left: '353px',
        top: '2191px'
    },
    {
        left: '193px',
        top: '1119px'
    },
    {
        left: '256px',
        top: '1119px'
    },
    {
        left: '65px',
        top: '911px'
    },
    {
        left: '255px',
        top: '911px'
    },
    {
        left: '289px',
        top: '879px'
    },
    {
        left: '319px',
        top: '845px'
    },
    {
        left: '191px',
        top: '637px'
    },
    {
        left: '320px',
        top: '637px'
    },
    {
        left: '384px',
        top: '637px'
    },
    {
        left: '128px',
        top: '542px'
    }
];

var game = document.getElementById('game-container');
var view = document.getElementById('character-view');
var stage = document.getElementById('stage');
var character_img = document.getElementById('character');
var character_container = document.getElementById('character-container');

var character = {
    position: 'north',
    rocketStatus: false
};

var tank_lib = [
    {
        direction: 'south-west',
        img: 'tanks/blue-sw.png'
    },
    {
        direction: 'west',
        img: 'tanks/blue-w.png'
    },
    {
        direction: 'north-west',
        img: 'tanks/blue-nw.png'
    },
    {
        direction: 'north',
        img: 'tanks/blue-n.png'
    },
    {
        direction: 'north-east',
        img: 'tanks/blue-ne.png'
    },
    {
        direction: 'east',
        img: 'tanks/blue-e.png'
    },
    {
        direction: 'south-east',
        img: 'tanks/blue-se.png'
    },
    {
        direction: 'south',
        img: 'tanks/blue-s.png'
    }
];

var rocket_lib = [
    {
        direction: 'south-west',
        img: 'assets/weapons/rocket-sw.png'
    },
    {
        direction: 'west',
        img: 'assets/weapons/rocket-w.png'
    },
    {
        direction: 'north-west',
        img: 'assets/weapons/rocket-nw.png'
    },
    {
        direction: 'north',
        img: 'assets/weapons/rocket-n.png'
    },
    {
        direction: 'north-east',
        img: 'assets/weapons/rocket-ne.png'
    },
    {
        direction: 'east',
        img: 'assets/weapons/rocket-e.png'
    },
    {
        direction: 'south-east',
        img: 'assets/weapons/rocket-se.png'
    },
    {
        direction: 'south',
        img: 'assets/weapons/rocket-s.png'
    }
];

var enemy_lib = [
    {
        direction: 'south-west',
        img: 'enemies/turret-sw.png'
    },
    {
        direction: 'west',
        img: 'enemies/turret-w.png'
    },
    {
        direction: 'north-west',
        img: 'enemies/turret-nw.png'
    },
    {
        direction: 'north',
        img: 'enemies/turret-n.png'
    },
    {
        direction: 'north-east',
        img: 'enemies/turret-ne.png'
    },
    {
        direction: 'east',
        img: 'enemies/turret-e.png'
    },
    {
        direction: 'south-east',
        img: 'enemies/turret-se.png'
    },
    {
        direction: 'south',
        img: 'enemies/turret-s.png'
    }
];

var enemies = [
    {
        left: '97px',
        top: '2495px'
    },
    {
        left: '191px',
        top: '2351px'
    },
    {
        left: '95px',
        top: '2191px'
    },
    {
        left: '255px',
        top: '2191px'
    },
    {
        left: '353px',
        top: '2191px'
    },
    {
        left: '193px',
        top: '1119px'
    },
    {
        left: '256px',
        top: '1119px'
    },
    {
        left: '65px',
        top: '911px'
    },
    {
        left: '255px',
        top: '911px'
    },
    {
        left: '289px',
        top: '879px'
    },
    {
        left: '319px',
        top: '845px'
    },
    {
        left: '191px',
        top: '637px'
    },
    {
        left: '320px',
        top: '637px'
    },
    {
        left: '384px',
        top: '637px'
    },
    {
        left: '128px',
        top: '542px'
    }
];

//enemies
function loadEnemies(){
    for(var i = 0; i < enemies.length; i++){
        var temp_container = document.createElement('DIV');
        var temp_img = document.createElement('IMG');
        temp_img.src = 'enemies/turret-s.png';
        //temp_img.alt = 'south';
        temp_container.appendChild(temp_img);
        temp_container.classList.add('turret');
        temp_container.style.left = enemies[i].left;
        temp_container.style.top = enemies[i].top;
        stage.appendChild(temp_container);
    }
}

function getCharacterOnStagePosition(){
    return Math.abs(parseInt(window.getComputedStyle(stage).top.replace('px', ''))) + parseInt(window.getComputedStyle(view).top.replace('px', '')) + parseInt(window.getComputedStyle(character_container).top.replace('px', ''));
}

var character = document.getElementById('character-container');
var game = document.getElementById('game-container');

//-----helper functions-----
function getDimensions(object){
    //console.log('getDimensions: ' + object);
    var width = parseInt(window.getComputedStyle(object).width.replace('px', ''));
    var height = parseInt(window.getComputedStyle(object).height.replace('px', ''));
    var left = parseInt(window.getComputedStyle(object).left.replace('px', ''));
    var right = left + width;
    var top = parseInt(window.getComputedStyle(object).top.replace('px', ''));
    var bottom = top + height;

    var returnObject = {
        left: left,
        right: right,
        top: top,
        bottom: bottom,
        width: width,
        height: height
    };

    return returnObject;
}
//Collision
function collision(objectOne, objectTwo){
    var rectangleOne = getDimensions(objectOne);
    var rectangleTwo = getDimensions(objectTwo);
    if (rectangleOne.left < rectangleTwo.right && rectangleOne.right > rectangleTwo.left && rectangleOne.top < rectangleTwo.bottom && rectangleOne.bottom > rectangleTwo.top) {
        return true; //collision detected
    }
    return false;
}
//------collision wrapper------
function objectCollisions(object){
    var removeables = Array.from(document.getElementsByClassName('removeables'));
    var nonremovables = Array.from(document.getElementsByClassName('nonremovables'));
    var obstacles = [removeables, nonremovables];
    
    var toReturn = {
        status: false,
        removeable: null,
        index: null
    };

    // console.log('removeables: ' + removeables.length);
    // console.log('nonremovables: ' + nonremovables.length);
    
    if(contains(object) == 1){
        for(var i = 0; i < obstacles.length; i++){
            arr = obstacles[i];
            for(var j = 0; j < arr.length; j++){
                if(collision(object, arr[j])){
                    toReturn.status = true;
                    if(i == 0){
                        toReturn.removeable = true;
                        toReturn.index = j;
                    }
                    else{
                        toReturn.removeable = false;
                    }
                    return toReturn;
                }
            }
        }
    }
    else{
        toReturn.status = true;
        toReturn.removeable = false;
    }
    return toReturn;
}
//-----game loading functions-----
function loadObstacles(){
    //first load boundry points, this is just for visual; temp
    loadPolyPoints();
    //load infrastructure
    var toLoad = [nonRemovables, turretLocations];
    for(var j = 0; j < toLoad.length; j++){
        arr = toLoad[j];
        for(var i = 0; i < arr.length; i++){
            var temp_container = document.createElement('DIV');
            var left = arr[i].left;
            var top = arr[i].top;
            if(j == 0){
                temp_container.style.height = arr[i].height;
                temp_container.style.width = arr[i].width;
                temp_container.className = 'nonremovables';
            }
            else{
                var rangeSquare = document.createElement('DIV');
                var Xbuffer = 100;
                var Ybuffer = 100;
                rangeSquare.className('rangeSquares');
                left = parseInt(left.replace('px', ''));
                top = parseInt(top.replace('px', ''));
                rangeSquare.style.left = (left - Xbuffer) + 'px';
                rangeSquare.style.top = (top - Ybuffer) + 'px';
                var temp_img = document.createElement('IMG');
                temp_img.src = 'enemies/turret-s.png'; //default position
                temp_img.className = 'south';
                temp_container.appendChild(temp_img);
                temp_container.id = '';
                temp_container.className = 'turrets';
                temp_container.classList.add('removeables');
            }
            temp_container.style.left = arr[i].left;
            temp_container.style.top = arr[i].top;
            game.appendChild(temp_container);
        }
    }
    //load range squares
    //makeRangeSquares();
}
function loadPolyPoints(){
    for(var i = 0; i < bounds.length; i++){
        var new_square = document.createElement('DIV');
        new_square.style.left = bounds[i].x + 'px';
        new_square.style.top = bounds[i].y + 'px';
        new_square.className = 'poly';
        game.appendChild(new_square);
    }
}
//-------------driver functions-------------
//movement functions
function moveX(object, direction, speedLimit){
    var objectDimensions = getDimensions(object);

    if(direction == 'west'){
        speedLimit = speedLimit * -1;
    }

    objectDimensions.left+=speedLimit;
    object.style.left = objectDimensions.left + 'px';
}
function moveY(object, direction, speedLimit){
    var objectDimensions = getDimensions(object);
    //console.log('moveY: ' + objectDimensions);

    if(direction == 'north'){
        speedLimit = speedLimit * -1;
    }

    objectDimensions.top+=speedLimit;
    object.style.top = objectDimensions.top + 'px';
    //console.log(object.style.top);
}
//rotation of character or turrets
function rotate(object, direction){
    //check if object orientation needs to change
    var characterDirection = object.firstChild.className;
    if(characterDirection != direction){
        var library;
        if(object.id == 'character-container'){
            library = tankLibrary;
            //console.log('tankLibrary');
        }
        else{
            library = turretLibrary;
        }
        var position = library.indexOf(library.find(({direction}) => direction === characterDirection));
        var right = false;
        var currentPosition = position;
        var minTurns = 4;
        for(var i=0; i < minTurns; i++){
            if(currentPosition != 7){
                currentPosition++;
            }
            else{
                currentPosition = 0;
            }
            if(library[currentPosition].direction == direction){
                right = true;
                break;
            }
        }
        if(right){
            if(position != 7){
                position++;
            }
            else{
                position = 0;
            }
        }
        else{
            if(position != 0){
                position--;
            }
            else{
                position = 7;
            }
        }
        object.firstChild.className = library[position].direction;
        object.firstChild.src = library[position].img;
        return false;
    }
    return true;
}
//checks if point is in polygon (object in map)
function contains(object) {
    var objectDimensions = getDimensions(object);
    lat = objectDimensions.top;
    lng = objectDimensions.left;
    //credit to
    //https://rosettacode.org/wiki/Ray-casting_algorithm
    var count = 0;
    for (var b = 0; b < bounds.length; b++) {
        var vertex1 = bounds[b];
        var vertex2 = bounds[(b + 1) % bounds.length];
        if (west(vertex1, vertex2, lng, lat))
            ++count;
    }
    return count % 2;
 
    /**
     * @return {boolean} true if (x,y) is west of the line segment connecting A and B
     */
    function west(A, B, x, y) {
        if (A.y <= B.y) {
            if (y <= A.y || y > B.y ||
                x >= A.x && x >= B.x) {
                return false;
            } else if (x < A.x && x < B.x) {
                return true;
            } else {
                return (y - A.y) / (x - A.x) > (B.y - A.y) / (B.x - A.x);
            }
        } else {
            return west(B, A, x, y);
        }
    }
}
//-------------driver functions-------------
//enemy helper functions
// function makeRangeSquares(){
//     var turrets = Array.from(document.getElementsByClassName('turrets'));
//     var turret;
//     var Xbuffer = 100;
//     var Ybuffer = 100;
//     for(var i = 0; i < turrets.length; i++){
//         turret = getDimensions(turrets[i]);
//         var rangeSquare = document.createElement('DIV');
//         rangeSquare.className = 'rangeSquares';
//         rangeSquare.style.left = (turret.left - Xbuffer) + 'px';
//         rangeSquare.style.top = (turret.top - Ybuffer) + 'px';
//         game.append(rangeSquare);
//     }
// }

document.addEventListener('load', loadEnemies());
var map = {};
onkeydown = onkeyup = function(e){
    e = e || event;
    map[e.key] = e.type == 'keydown';
    
    if(map['w'] && map['d']){
        move('north-east');
    }
    else if(map['w'] && map['a']){
        move('north-west');
    }
    else if(map['s'] && map['a']){
        move('south-west');
    }
    else if(map['s'] && map['d']){
        move('south-east');
    }
    else if(map['w']){
        move('north');
    }
    else if(map['d']){
        move('east');
    }
    else if(map['s']){
        move('south');
    }
    else if(map['a']){
        move('west');
    }
    if(map[' ']){
        shootRocket();
        character.rocketStatus = true;
    }
}

function move(dir){
    if(dir != character.position){
        var position = tank_lib.indexOf(tank_lib.find(({direction}) => direction === character.position));
        var right = false;
        var curr_position = position;
        var MIN_TURNS = 4;
        for(var i=0; i < MIN_TURNS; i++){
            if(curr_position != 7){
                curr_position++;
            }
            else{
                curr_position = 0;
            }
            if(tank_lib[curr_position].direction == dir){
                right = true;
                break;
            }
        }
        if(right){
            if(position != 7){
                position++;
            }
            else{
                position = 0;
            }
        }
        else{
            if(position != 0){
                position--;
            }
            else{
                position = 7;
            }
        }
        character.position = tank_lib[position].direction;
        character_img.src = tank_lib[position].img;
    }
    else{
        if(dir == 'north' || dir == 'north-west' || dir == 'north-east'){
            moveY('north');
            if(dir == 'north-west'){
                moveX('west');
            }
            else if(dir == 'north-east'){
                moveX('east');
            }
        }
        else if(dir == 'south' || dir == 'south-east' || dir == 'south-west'){
            moveY('south');
            if(dir == 'south-east'){
                moveX('east');
            }
            else if(dir == 'south-west'){
                moveX('west');
            }
        }
        else if(dir == 'east'){
            moveX('east');
        }
        else{
            moveX('west');
        }
    }
}
//fix this for new stage, move faster
function moveX(dir){
    var num_character_style = parseInt(window.getComputedStyle(character_container).left.replace('px', ''));
    var BOUNDS = {
        right: 490,
        left: 0
    }

    var SPEED_LIMIT = 5;
    
    if(dir == 'east'){
        if(num_character_style < BOUNDS.right){
            num_character_style+=SPEED_LIMIT;
            character_container.style.left = num_character_style + 'px';
        }
    }
    else{
        if(num_character_style > BOUNDS.left){
            num_character_style-=SPEED_LIMIT;
            character_container.style.left = num_character_style + 'px';
        }
    }
}
//fix this for new stage, move faster
function moveY(dir){
    var num_stage_style = parseInt(window.getComputedStyle(stage).top.replace('px', ''));
    var num_view_style = parseInt(window.getComputedStyle(view).top.replace('px', ''));
    var num_character_style = parseInt(window.getComputedStyle(character_container).top.replace('px', ''));

    var BOUNDS = {
        stage_bottom: -2570,
        stage_top: 0,
        view_bottom: 200,
        view_center_top: 100,
        view_top: 0,
        character_bottom: 75,
        character_center_top: 40,
        character_top: 0
    }

    var SPEED_LIMIT = 5;

    if(dir == 'north'){
        if(num_character_style > BOUNDS.character_center_top){
            num_character_style-=SPEED_LIMIT;
            character_container.style.top = num_character_style + 'px';
        }
        else if(num_view_style > BOUNDS.view_center_top){
            num_view_style-=SPEED_LIMIT;
            view.style.top = num_view_style + 'px';
        }
        else if(num_stage_style < BOUNDS.stage_top){
            num_stage_style+=SPEED_LIMIT;
            stage.style.top = num_stage_style + 'px';
        }
        else if(num_view_style > BOUNDS.view_top){
            num_view_style-=SPEED_LIMIT;
            view.style.top = num_view_style + 'px';
        }
        else if (num_character_style > BOUNDS.character_top){
            num_character_style-=SPEED_LIMIT;
            character_container.style.top = num_character_style + 'px';
        }
    }
    else{
        if(num_character_style < BOUNDS.character_center_top){
            num_character_style+=SPEED_LIMIT;
            character_container.style.top = num_character_style + 'px';
        }
        else if(num_view_style < BOUNDS.view_center_top){
            num_view_style+=SPEED_LIMIT;
            view.style.top = num_view_style + 'px';
        }
        else if(num_stage_style > BOUNDS.stage_bottom){
            num_stage_style-=SPEED_LIMIT;
            stage.style.top = num_stage_style + 'px';
        }
        else if(num_view_style < BOUNDS.view_bottom){
            num_view_style+=SPEED_LIMIT;
            view.style.top = num_view_style + 'px';
        }
        else if(num_character_style < BOUNDS.character_bottom){
            num_character_style+=SPEED_LIMIT;
            character_container.style.top = num_character_style + 'px';
        }
    }
}
//----main character shooting
function shootRocket(){
    if(!character.rocketStatus){
        var rocket = document.createElement('DIV');
        rocket.id = 'rocket';
        var rocket_img = document.createElement('IMG');

        var position = tank_lib.indexOf(tank_lib.find(({direction}) => direction === character.position));

        rocket_img.src = rocket_lib[position].img;
        rocket.appendChild(rocket_img);

        rocket.style.width = '12px';
        rocket.style.height = '12px';
        rocket.style.position = 'absolute';

        var num_left = parseInt(window.getComputedStyle(character_container).left.replace('px', ''));
        var num_top = getCharacterOnStagePosition();

        rocket.style.left = num_left + 'px';
        rocket.style.top = num_top + 'px';

        stage.appendChild(rocket);

        var DURATION = 1000; //ms
        var INTERVAL_TIME = 100; //ms

        var flight_path = character.position;
        var flight_time;
        
        var intervalX; // x axis
        var intervalY;

        if(flight_path == 'north' || flight_path == 'south'){
            intervalX = 0;
            intervalY = 14; //px
            //intervalY = 25;
        }
        else if(flight_path == 'east' || flight_path == 'west'){
            intervalX = 14; //px
            intervalY = 0;
        }
        else{
            intervalX = 10; //px
            intervalY = 10; //px
        }

        var rocketX = (DURATION/INTERVAL_TIME) * intervalX; //distance traveled in x axis
        var rocketY = (DURATION/INTERVAL_TIME) * intervalY; //distance traveled in y axis
        
        var collision = withinRange(rocketX, rocketY, flight_path);
        var collision_time;

        if(flight_path == 'north' || flight_path == 'south'){
            collision_time = Math.floor(((INTERVAL_TIME/intervalY) * collision.distanceY));
            console.log('time to collide: ' + collision_time);
        }
        else if(flight_path == 'east' || flight_path == 'west'){
            collision_time = Math.floor(((INTERVAL_TIME/intervalX) * collision.distanceX));
            console.log('time to collide: ' + collision_time);
        }
        else{
            var square = 2;
            var intervalC = Math.sqrt(Math.floor(Math.pow(intervalX, square) + Math.pow(intervalY, square)));
            var distanceC = Math.sqrt(Math.floor(Math.pow(collision.distanceX, square) + Math.pow(collision.distanceY, square)));
            collision_time = Math.floor((INTERVAL_TIME/intervalC) * distanceC);
            console.log('time to collide: ' + collision_time);
            console.log('interval c: ' + intervalC);
            console.log('distance c: ' + distanceC);
        }
        
        if(collision.status == true){
            flight_time = Date.now() + collision_time;
        }
        else{
            flight_time = Date.now() + DURATION;
        }

        var flying = setInterval(()=>{
            if(flight_path == 'north' || flight_path == 'north-east' || flight_path == 'north-west'){
                num_top-=intervalY;
                if(flight_path == 'north-east'){
                    num_left+=intervalX;
                }
                else if(flight_path == 'north-west'){
                    num_left-=intervalX;
                }
            }
            else if(flight_path == 'south' || flight_path == 'south-east' || flight_path == 'south-west'){
                num_top+=intervalY;
                if(flight_path == 'south-east'){
                    num_left+=intervalX;
                }
                else if(flight_path == 'south-west'){
                    num_left-=intervalX;
                }
            }
            else if(flight_path == 'west'){
                num_left-=intervalX;
            }
            else if(flight_path == 'east'){
                num_left+=intervalX;
            }
            rocket.style.top = num_top + 'px';
            rocket.style.left = num_left + 'px';
            if(Date.now() > flight_time){
                clearInterval(flying);
                var explosion = document.createElement('DIV');
                var explosion_img = document.createElement('IMG');
                explosion_img.src = 'assets/environment/explosions/explosion.gif';
                explosion.appendChild(explosion_img);
                explosion.style.width = '30px';
                explosion.style.height = '30px';
                explosion.style.position = 'absolute';
                explosion.style.left = window.getComputedStyle(rocket).left;
                explosion.style.top = window.getComputedStyle(rocket).top;
                rocket.remove();
                stage.appendChild(explosion);
                setTimeout(()=>{
                    if(collision.status == true){
                        console.log('BOOM!');
                        var turret = document.getElementsByClassName('turret')[collision.index];
                        console.log('destroyed ' + turret.style.left + ' ' + turret.style.top);
                        console.log('character ' + window.getComputedStyle(character_container).left + ' ' + window.getComputedStyle(character_container).top);
                        turret.remove();
                    }
                    else{
                        console.log('miss');
                    }
                    explosion.remove();
                    character.rocketStatus = false;
                },500);
            }
        }, INTERVAL_TIME);
    }
}

function withinRange(rocketX, rocketY, direction){

    var toReturn = {
        status: false, //did it hit?
        index: null, //which turret did it hit?
        distanceX: null,
        distanceY: null
    };

    var turrets = Array.from(document.getElementsByClassName('turret'));
    var character_left = parseInt(window.getComputedStyle(character_container).left.replace('px', ''));
    var character_top = getCharacterOnStagePosition();

    var index;

    for(var i = 0; i < turrets.length; i++){
        var turret_left = parseInt(window.getComputedStyle(turrets[i]).left.replace('px', ''));
        var turret_right = parseInt(window.getComputedStyle(turrets[i]).width.replace('px', '')) + turret_left;
        var turret_top = parseInt(window.getComputedStyle(turrets[i]).top.replace('px', ''));
        var turret_bottom = parseInt(window.getComputedStyle(turrets[i]).height.replace('px', '')) + turret_top;

        var differenceX;
        var differenceY;

        if(direction == 'north' || direction == 'south'){
            if((direction == 'north' && character_top < turret_top) || (direction == 'south' && character_top > turret_top)){
                continue;
            }
            else{
                differenceX = 0;
                if(direction == 'north'){
                    differenceY = character_top - turret_top;
                }
                else{
                    differenceY = turret_top - character_top;
                }
            }
            if(turret_left <= character_left && character_left <= turret_right && rocketY > differenceY){
                index = i;
                toReturn.distanceY = differenceY;
                break;
            }
        }
        else if(direction == 'west' || direction == 'east'){
            if((direction == 'west' && character_left < turret_left) || (direction == 'east' && character_left > turret_left)){
                continue;
            }
            else{
                differenceY = 0;

                if(direction == 'west'){
                    differenceX = character_left - turret_left;
                }
                else{
                    differenceX = turret_left - character_left;
                }
                if((turret_top <= character_top && character_top <= turret_bottom) && rocketX > differenceX){
                    console.log('hit!');
                    index = i;
                    toReturn.distanceX = differenceX;
                    break;
                }
            }
        }
        else{
            var nw_bool = (direction == 'north-west' && !(character_left > turret_left && character_top > turret_top));
            var ne_bool = (direction == 'north-east' && !(character_left < turret_left && character_top > turret_top));
            var sw_bool = (direction == 'south-west' && !(character_left > turret_left && character_top < turret_top));
            var se_bool = (direction == 'south-east' && !(character_left < turret_left && character_top < turret_top));
            if(nw_bool || ne_bool || sw_bool || se_bool){
                continue;
            }
            if(direction == 'north-west' || direction == 'north-east'){
                differenceY = character_top - turret_top;
                if(direction == 'north-west'){
                    differenceX = character_left - turret_left;
                }
                else{
                    differenceX = turret_left - character_left;
                }
            }
            else{
                differenceY = turret_top - character_top;
                if(direction == 'south-west'){
                    differenceX = character_left - turret_left;
                }
                else{
                    differenceX = turret_left - character_left;
                }
            }
            if(rocketX > differenceX && rocketY > differenceY){
                console.log('hit!');
                index = i;
                toReturn.distanceX = differenceX;
                toReturn.distanceY = differenceY;
                break;
            }
        }
    }

    if(typeof index != 'undefined'){
        toReturn.status = true;
        toReturn.index = index;
    }
    else{
        console.log('undefined');
    }

    return toReturn;
}
//enemy direction and shooting behavior

var enemy_interval = 100;

setInterval(() => {
    enemyShooting();
}, enemy_interval);

function enemyShooting(){
    var turrets = Array.from(document.getElementsByClassName('turret'));

    for(var i = 0; i < turrets.length; i++){
        var turret = turrets[i];
        var turret_top = parseInt(window.getComputedStyle(turret).top.replace('px', ''));
        if(enemyWithinView(turret_top)){
            //if not in proper direction,rotate into proper position
            enemyRotate(i);
            //shoot
        }
    }
}

function enemyRotate(index){
    var turrets = Array.from(document.getElementsByClassName('turret'));
    var turret = turrets[index];
    var turret_left = parseInt(window.getComputedStyle(turret).left.replace('px', ''));
    var turret_right = parseInt(window.getComputedStyle(turret).width.replace('px', '')) + turret_left;
    var turret_top = parseInt(window.getComputedStyle(turret).top.replace('px', ''));
    var turret_bottom = parseInt(window.getComputedStyle(turret).height.replace('px', '')) + turret_top;
    var character_top = getCharacterOnStagePosition();
    var character_left = parseInt(window.getComputedStyle(character_container).left.replace('px', ''));

    var new_direction;

    if(character_left < turret_left && character_top < turret_top){
        new_direction = 'north-west';
    }
    else if(character_left > turret_right && character_top < turret_top){
        new_direction = 'north-east';
    }
    else if(character_left < turret_left && character_top > turret_bottom){
        new_direction = 'south-west';
    }
    else if(character_left > turret_right && character_top > turret_bottom){
        new_direction = 'south-east';
    }
    else if(turret_left < character_left && character_left < turret_right && character_top < turret_top){
        new_direction = 'north';
    }
    else if(turret_left < character_left && character_left < turret_right && character_top > turret_bottom){
        new_direction = 'south';
    }
    else if(character_top > turret_top && character_top < turret_bottom && character_left < turret_left){
        new_direction = 'west';
    }
    else{
        new_direction = 'east';
    }
    var position = enemy_lib.indexOf(enemy_lib.find(({direction}) => direction === new_direction));
    turret.firstChild.src = enemy_lib[position].img;

    console.log('turret: ' + index + ' dir: ' + new_direction);

}

function enemyWithinView(enemyY){
    var view_top_bound = Math.abs(parseInt(window.getComputedStyle(stage).top.replace('px', ''))) + parseInt(window.getComputedStyle(view).top.replace('px', ''));
    var view_bottom_bound = view_top_bound + parseInt(window.getComputedStyle(view).height.replace('px', ''));
    return (view_top_bound <= enemyY && enemyY <= view_bottom_bound);
}

//first load obstacles
window.addEventListener('load', loadObstacles());
//key handler
var map = {};
onkeydown = onkeyup = function(e){
    e = e || event;
    map[e.key] = e.type == 'keydown';
    e.preventDefault();
    if(map['w'] && map['d']){
        characterMovement('north-east');
    }
    else if(map['w'] && map['a']){
        characterMovement('north-west');
    }
    else if(map['s'] && map['d']){
        characterMovement('south-east');
    }
    else if(map['s'] && map['a']){
        characterMovement('south-west');
    }
    else if(map['w']){
        characterMovement('north');
    }
    else if(map['d']){
        characterMovement('east');
    }
    else if(map['s']){
        characterMovement('south');
    }
    else if(map['a']){
        characterMovement('west');
    }
    if(map[' ']){
        shootSquare(character);
    }
}
//------movement-----
//------character movement wrapper-----
function characterMovement(direction){
    //rate at which this object will move
    var speedLimit = 10;
    //make clone and move it: if not in bounds do not move character else rotate and move character
    var characterClone = character.cloneNode(false);
    game.appendChild(characterClone);
    moveObject(characterClone, direction, speedLimit);
    var checkCharacterBounds = objectCollisions(characterClone);
    //do not need clone, remove from game
    characterClone.remove();
    //rotate to proper orientation and move this object
    if(!checkCharacterBounds.status){
        rotate(character, direction);
        moveObject(character, direction, speedLimit);
    }
    //else do nothing
}
//------character movement wrapper-----
function moveObject(object, direction, speedLimit){
    if(direction == 'north' || direction == 'south'){
        moveY(object, direction, speedLimit);
    }
    else if(direction == 'east' || direction == 'west'){
        moveX(object, direction, speedLimit);
    }
    else{
        var X = 'east';
        var Y = 'north';
        if(direction.includes('west')){
            X = 'west';
        }
        if(direction.includes('south')){
            Y = 'south';
        }
        moveY(object, Y, speedLimit);
        moveX(object, X, speedLimit);
    }
}
//------movement-----
function shootSquare(object){
    var objectDimensions = getDimensions(object);
    var projectile = makeProjectile(objectDimensions.left, objectDimensions.top);
    var projectileImg = document.createElement('IMG');

    if(object.id == 'character-container'){
        var index = tankLibrary.indexOf(tankLibrary.find(({direction}) => direction === object.firstChild.className));
        projectileImg.src = rocketLibrary[index].img;
    }
    else{
        projectileImg.src = 'assets/weapons/projectile.png';
    }
    projectile.appendChild(projectileImg);
    //console.log(projectileImg);
    console.log(projectile);
    game.appendChild(projectile);
    projectileMovement(projectile, object.firstChild.className);
}
function makeProjectile(left, top){
    var projectile = document.createElement('DIV');
    projectile.className = 'projectile';
    projectile.style.left = left + 'px';
    projectile.style.top = top + 'px';
    return projectile;
}
function projectileMovement(projectile, direction){
    var intervalTime = 100;
    var flightTime = 1100;
    var minTime = Date.now() + flightTime; 
    var speedLimit = 20;
    var projectileCollision;
    var projectileInterval = setInterval(()=>{
        moveObject(projectile, direction, speedLimit);
        projectileCollision = objectCollisions(projectile);
        if(Date.now() > minTime || projectileCollision.status){
            if(projectileCollision.status && projectileCollision.removeable){
                removeObstacle(projectileCollision.index);
            }
            clearInterval(projectileInterval);
            projectileExplosion(projectile.style.left, projectile.style.top);
            projectile.remove();
        }
    }, intervalTime);
}
function removeObstacle(index){
    var removeables = Array.from(document.getElementsByClassName('removeables'));
    removeables[index].remove();
}
function projectileExplosion(left, top){
    var explosion = document.createElement('DIV');
    var explosion_img = document.createElement('IMG');
    explosion_img.src = 'assets/environment/explosions/explosion.gif'
    explosion.style.left = left;
    explosion.style.top = top;
    explosion.className = 'explosion';
    explosion.appendChild(explosion_img);
    game.appendChild(explosion);
    var explosionTime = 500;
    setInterval(()=>{
        explosion.remove();
    }, explosionTime);   
}
//enemy behavior
var enemyInterval = 250;

setInterval(() => {
    enemyShooting();
    //console.log('run enemy script');
}, enemyInterval);

function enemyShooting(){
    //var turrets = Array.from(document.getElementsByClassName('turrets'));

    //console.log('enemyShooting: testing withinRange: ' + withinRange());
    //console.log('b4 rotate');
    //enemyRotate(i);
    //enemyShoot(i);
}
function withinRange(){
    var rangeSquares = Array.from(document.getElementsByClassName('rangeSquares'))
    for(var i = 0; i < rangeSquares.length; i++){
        if(collision(character, rangeSquares[i])){
            return true;
        }
    }
    return false;
}
function enemyRotate(index){
    var turret = Array.from(document.getElementsByClassName('turret'))[index];
    var direction = turretPostion(turret);
    var result;
    var rotationTime = 100;
    var timedRotation = setInterval(()=>{
        result = rotate(turret, direction);
        if(!result){
            clearInterval(timedRotation);
        }
    }, rotationTime);
}
function turretPostion(turret){
    var turretDim = getDimensions(turret);
    var characterDim = getDimensions(character);
    var direction;
    if(characterDim.left < turretDim.left && characterDim.top < turretDim.top){
        direction = 'north-west';
    }
    else if(characterDim.left > turretDim.right && characterDim.top < turretDim.top){
        direction = 'north-east';
    }
    else if(characterDim.left < turretDim.left && characterDim.top > turretDim.bottom){
        direction = 'south-west';
    }
    else if(characterDim.left > turretDim.right && characterDim.top > turretDim.top){
        direction = 'south-east';
    }
    else if(turretDim.left < characterDim.left && characterDim.left < turretDim.right && characterDim.top < turretDim.top){
        direction = 'north';
    }
    else if(turretDim.left < characterDim.left && characterDim.left < turretDim.right && characterDim.top > turretDim.top){
        direction = 'south';
    }
    else if(characterDim.top > turretDim.top && characterDim.top < turretDim.bottom && characterDim.left < turretDim.left){
        direction = 'west';
    }
    else{
        direction = 'east';
    }
    return direction;
}